name: "$(Build.SourceBranchName)-infrastructure"

# This pipeline is for manual runs only - PR validation uses pipeline-full-deployment.yml
trigger: none
pr: none

parameters:
  - name: destroy
    displayName: Destroy Environment
    type: boolean
    default: false

  - name: deploy
    displayName: Deploy Environment
    type: boolean
    default: true

  - name: environment
    displayName: Environment Group
    type: string
    default: nonprod
    values:
      - nonprod
      - prod

  - name: env_name
    displayName: Environment Name
    default: dev
    values:
      - dev
      - qa
      - uat
      - prod
    type: string

  - name: pipeline_definition_id
    displayName: Networking Pipeline Definition ID
    type: string
    default: "112"

  - name: use_agent_pool
    displayName: Use Self-Hosted Agent Pool
    type: boolean
    default: false

  - name: agent_pool_name
    displayName: Agent Pool Name
    type: string
    default: "ensono-data-euw-hub-agent-pool"

variables:
  - name: CLOUD_PLATFORM
    value: azure
  - name: ENV_NAME
    value: ${{ parameters.env_name }}

# Define the stages of the infra deployment pipeline
stages:
  - stage: Infrastructure

    variables:
      - template: variables.yml
        parameters:
          environment: ${{ parameters.environment }}
      # Include the networking group that created in the previous stage
      - group: ${{ variables.company }}-${{ variables.project }}-${{ variables.domain }}-networking-${{ variables.ENV_NAME }}
      - name: STAGE
        value: infra
      - name: TF_FILE_LOCATION
        value: /eirctl/deploy/terraform/infra
      - name: tf_state_key
        value: $(company)-$(project)-$(domain)-infra

    pool:
      # Set the correct pool or build image based on the parameters
      ${{ if eq(parameters.use_agent_pool, true) }}:
        name: ${{ parameters.agent_pool_name }}
      ${{ else }}:
        vmImage: "ubuntu-latest"

    jobs:
      - job: Deploy
        workspace:
          clean: outputs

        steps:
          - template: templates/terraform-deploy.yml
            parameters:
              stage_name: infra
              tf_state_key: $(company)-$(project)-$(domain)-infra
              download_artifact: networking
              artifact_file: $(env_name)-networking-inputs.auto.tfvars
              destroy: ${{ parameters.destroy }}
              deploy: ${{ parameters.deploy }}
