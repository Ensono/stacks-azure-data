# Reusable template for networking-specific Terraform deployment
parameters:
  - name: destroy
    type: boolean
    default: false
  - name: deploy
    type: boolean
    default: true

steps:
  - checkout: self
    clean: true

  - template: install-eirctl.yml
    parameters:
      EirctlVersion: $(EirctlVersion)

  - task: Bash@3
    displayName: "Eirctl: Terraform inputs file"
    inputs:
      targetType: inline
      script: |
        eirctl infra:vars
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      TF_VAR_name_company: $(company)
      TF_VAR_name_project: $(project)
      TF_VAR_enable_private_networks: $(enable_private_networks)
      TF_VAR_resource_group_location: $(region)
      TF_VAR_ado_create_agent_pool: $(ado_create_agent_pool)
      TF_VAR_ado_create_variable_group: $(ado_create_variable_group)
      TF_VAR_ado_org_url: $(ado_org_url)
      TF_VAR_ado_project_id: $(ado_project_id)

  - task: Bash@3
    displayName: "Eirctl: Initialise Terraform"
    inputs:
      targetType: inline
      script: |
        export USER_ID=`id -u`
        export USER_GROUP_ID=`id -g`
        eirctl infra:init
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      TF_BACKEND_INIT: "key=$(company)-$(project)-$(domain)-networking,storage_account_name=$(tf_state_storage),resource_group_name=$(tf_state_rg),container_name=$(tf_state_container)"

  - ${{ if eq(parameters.destroy, true) }}:
      - task: Bash@3
        displayName: "Eirctl: [DESTROY] Plan Networking"
        inputs:
          targetType: inline
          script: |
            eirctl infra:destroy:plan
        env:
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_TENANT_ID: $(ARM_TENANT_ID)

      - task: Bash@3
        displayName: "Eirctl: [DESTROY] Apply Networking"
        inputs:
          targetType: inline
          script: |
            eirctl infra:destroy:apply
        env:
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_TENANT_ID: $(ARM_TENANT_ID)

  - ${{ if eq(parameters.deploy, true) }}:
      - task: Bash@3
        displayName: "Eirctl: Plan Networking"
        inputs:
          targetType: inline
          script: |
            eirctl infra:plan
        env:
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_TENANT_ID: $(ARM_TENANT_ID)

      - task: Bash@3
        displayName: "Eirctl: Import Existing Resources (State Reconciliation)"
        continueOnError: true
        inputs:
          targetType: inline
          script: |
            set +e  # Allow script to continue on errors

            echo "Importing existing resources into Terraform state..."

            cd deploy/terraform/networking

            # Import Azure DevOps agent pool (if exists)
            terraform import \
              'module.azure_devops.azuredevops_agent_pool.ensono_pool[0]' \
              '$(ado_project_id)/ensono-data-euw-hub-agent-pool' 2>/dev/null || echo "Agent pool import skipped or already in state"

            # Import resource groups (if they exist)
            terraform import \
              'module.networking.azurerm_resource_group.hub[0]' \
              '/subscriptions/$(ARM_SUBSCRIPTION_ID)/resourceGroups/ensono-data-euw-hub' 2>/dev/null || echo "Hub RG import skipped or already in state"

            terraform import \
              'module.networking.azurerm_resource_group.dev[0]' \
              '/subscriptions/$(ARM_SUBSCRIPTION_ID)/resourceGroups/ensono-data-euw-data-dev-network' 2>/dev/null || echo "Dev RG import skipped or already in state"

            terraform import \
              'module.networking.azurerm_resource_group.qa[0]' \
              '/subscriptions/$(ARM_SUBSCRIPTION_ID)/resourceGroups/ensono-data-euw-data-qa-network' 2>/dev/null || echo "QA RG import skipped or already in state"

            echo "Import phase complete. Continuing with apply..."
        env:
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_TENANT_ID: $(ARM_TENANT_ID)

      - task: Bash@3
        displayName: "Eirctl: Apply Networking"
        inputs:
          targetType: inline
          script: |
            eirctl infra:apply
        env:
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_TENANT_ID: $(ARM_TENANT_ID)

      - task: CopyFiles@2
        displayName: Copy stage output files to staging area
        inputs:
          flattenFolders: true
          contents: $(Build.SourcesDirectory)/outputs/terraform/*networking*
          targetFolder: $(Build.ArtifactStagingDirectory)/networking

      - task: Bash@3
        displayName: "Ensure networking artifact directory exists"
        inputs:
          targetType: inline
          script: |
            mkdir -p $(Build.ArtifactStagingDirectory)/networking
            echo "Staging directory prepared: $(Build.ArtifactStagingDirectory)/networking"

      - task: PublishPipelineArtifact@1
        displayName: Upload Generated Files
        inputs:
          targetPath: $(Build.ArtifactStagingDirectory)/networking
          artifact: networking
