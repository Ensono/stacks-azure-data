# Reusable template for pulling eir-infrastructure from ACR
parameters:
  - name: EirctlVersion
    type: string

steps:
  - task: Bash@3
    displayName: "Docker: Pull eir-infrastructure from ACR"
    inputs:
      targetType: inline
      script: |
        set -e
        echo "Authenticating to Azure and ACR..."
        # Ensure required environment variables are present
        : "${ARM_CLIENT_ID:?ARM_CLIENT_ID is required}"
        : "${ARM_CLIENT_SECRET:?ARM_CLIENT_SECRET is required}"
        : "${ARM_TENANT_ID:?ARM_TENANT_ID is required}"
        : "${ARM_SUBSCRIPTION_ID:?ARM_SUBSCRIPTION_ID is required}"

        # Explicitly set Azure cloud then authenticate
        az cloud set --name AzureCloud --only-show-errors
        az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID" --output none --only-show-errors
        az account set --subscription "$ARM_SUBSCRIPTION_ID" --only-show-errors
        az acr login --name ensonostackseuweirdfmu --output none --only-show-errors

        IMAGE_VERSION="${{ parameters.EirctlVersion }}"
        ACR_IMAGE="ensonostackseuweirdfmu.azurecr.io/eir-infrastructure:${IMAGE_VERSION}"
        FALLBACK_ACR_IMAGE="ensonostackseuweirdfmu.azurecr.io/eir-infrastructure:latest"

        echo "Pulling $ACR_IMAGE (fallback to latest if needed)"
        if ! docker pull "$ACR_IMAGE"; then
          echo "Falling back to $FALLBACK_ACR_IMAGE"
          docker pull "$FALLBACK_ACR_IMAGE"
          ACR_IMAGE="$FALLBACK_ACR_IMAGE"
        fi

        echo "Retagging for eirctl references"
        docker tag "$ACR_IMAGE" ensono/eir-infrastructure:${IMAGE_VERSION} || true
        docker tag "$ACR_IMAGE" ensono/eir-infrastructure:latest || true
        docker tag "$ACR_IMAGE" ghcr.io/ensono/eir-infrastructure:${IMAGE_VERSION} || true
        docker tag "$ACR_IMAGE" ghcr.io/ensono/eir-infrastructure:latest || true
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
