parameters:
  - name: EirctlVersion
    type: string
  - name: CloudName
    type: string
    default: AzureCloud
  - name: AcrName
    type: string
    default: ensonostackseuweirdfmu
  - name: InfraImageTag
    type: string
    default: "1.2.36"
  - name: DataImageTag
    type: string
    default: "latest"

steps:
  # Install Eirctl so that the tests can be run
  - task: Bash@3
    displayName: "Install: Eirctl"
    inputs:
      targetType: inline
      script: |
        sudo wget https://github.com/Ensono/eirctl/releases/download/${{ parameters.EirctlVersion }}/eirctl-linux-amd64 -O /usr/local/bin/eirctl
        sudo chmod +x /usr/local/bin/eirctl

  - task: Bash@3
    displayName: "Pre-cache Container Layers"
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        echo "Authenticating to Azure and ACR..."
        : "${ARM_CLIENT_ID:?ARM_CLIENT_ID is required}"
        : "${ARM_CLIENT_SECRET:?ARM_CLIENT_SECRET is required}"
        : "${ARM_TENANT_ID:?ARM_TENANT_ID is required}"
        : "${ARM_SUBSCRIPTION_ID:?ARM_SUBSCRIPTION_ID is required}"

        az cloud set --name ${{ parameters.CloudName }} --only-show-errors
        az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID" --output none --only-show-errors
        az account set --subscription "$ARM_SUBSCRIPTION_ID" --only-show-errors
        az acr login --name ${{ parameters.AcrName }} --output none --only-show-errors

        ACR_URL="${{ parameters.AcrName }}.azurecr.io"

        echo "Pulling and retagging images quietly..."
        # Pull infra image quietly and retag to match contexts.yaml
        if ! docker pull "$ACR_URL/ensono/eir-infrastructure:latest" >/dev/null 2>&1; then
          echo "Failed to pull $ACR_URL/ensono/eir-infrastructure:latest"
          exit 1
        fi
        docker tag "$ACR_URL/ensono/eir-infrastructure:latest" "ensono/eir-infrastructure:${{ parameters.InfraImageTag }}" >/dev/null 2>&1

        # Pull data image quietly and retag (best-effort)
        if docker pull "$ACR_URL/ensono/eir-azure-data:latest" >/dev/null 2>&1; then
          docker tag "$ACR_URL/ensono/eir-azure-data:latest" "ensono/eir-azure-data:${{ parameters.DataImageTag }}" >/dev/null 2>&1
        else
          echo "Warning: Could not pull $ACR_URL/ensono/eir-azure-data:latest (continuing)"
        fi

        echo "Images ready: ensono/eir-infrastructure:${{ parameters.InfraImageTag }}, ensono/eir-azure-data:${{ parameters.DataImageTag }}"
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
