parameters:
  - name: EirctlVersion
    type: string
  - name: CloudName
    type: string
    default: AzureCloud
  - name: AcrName
    type: string
    default: ensonostackseuweirdfmu
  - name: EirctlImageTag
    type: string
    default: "latest"

steps:
  # Install Eirctl so that the tests can be run
  - task: Bash@3
    displayName: "Install: Eirctl"
    inputs:
      targetType: inline
      script: |
        sudo wget https://github.com/Ensono/eirctl/releases/download/${{ parameters.EirctlVersion }}/eirctl-linux-amd64 -O /usr/local/bin/eirctl
        sudo chmod +x /usr/local/bin/eirctl

  - task: Cache@2
    displayName: "Cache: Docker Images"
    inputs:
      key: 'docker-images-v2 | "$(Agent.OS)" | "${{ parameters.EirctlImageTag }}"'
      path: $(Pipeline.Workspace)/.docker-cache
      restoreKeys: |
        docker-images-v2 | "$(Agent.OS)"
    continueOnError: true

  - task: Bash@3
    displayName: "Restore Cached Docker Images"
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        CACHE_DIR="$(Pipeline.Workspace)/.docker-cache"

        if [ -f "$CACHE_DIR/eir-infrastructure.tar" ]; then
          echo "Loading cached eir-infrastructure image..."
          docker load -i "$CACHE_DIR/eir-infrastructure.tar" || echo "Failed to load cached image"
        fi

        if [ -f "$CACHE_DIR/eir-azure-data.tar" ]; then
          echo "Loading cached eir-azure-data image..."
          docker load -i "$CACHE_DIR/eir-azure-data.tar" || echo "Failed to load cached image"
        fi
    continueOnError: true

  - task: Bash@3
    displayName: "Pre-cache Container Layers"
    inputs:
      targetType: inline
      script: |
        set -euo pipefail
        echo "Authenticating to Azure and ACR..."
        : "${ARM_CLIENT_ID:?ARM_CLIENT_ID is required}"
        : "${ARM_CLIENT_SECRET:?ARM_CLIENT_SECRET is required}"
        : "${ARM_TENANT_ID:?ARM_TENANT_ID is required}"
        : "${ARM_SUBSCRIPTION_ID:?ARM_SUBSCRIPTION_ID is required}"

        az cloud set --name ${{ parameters.CloudName }} --only-show-errors
        az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID" --output none --only-show-errors
        az account set --subscription "$ARM_SUBSCRIPTION_ID" --only-show-errors
        az acr login --name ${{ parameters.AcrName }} --output none --only-show-errors

        ACR_URL="${{ parameters.AcrName }}.azurecr.io"
        CACHE_DIR="$(Pipeline.Workspace)/.docker-cache"
        mkdir -p "$CACHE_DIR"

        echo "Pulling and retagging images quietly..."
        # Pull infra image quietly and retag to match contexts.yaml
        if ! docker image inspect "ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1; then
          echo "Pulling ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}..."
          if ! docker pull "$ACR_URL/ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1; then
            echo "Failed to pull $ACR_URL/ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}"
            exit 1
          fi
          docker tag "$ACR_URL/ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}" "ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1
          echo "Saving image to cache..."
          docker save "ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}" -o "$CACHE_DIR/eir-infrastructure.tar"
        else
          echo "Image ensono/eir-infrastructure:${{ parameters.EirctlImageTag }} already exists locally"
        fi

        # Pull data image quietly and retag (best-effort)
        if ! docker image inspect "ensono/eir-azure-data:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1; then
          echo "Pulling ensono/eir-azure-data:${{ parameters.EirctlImageTag }}..."
          if docker pull "$ACR_URL/ensono/eir-azure-data:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1; then
            docker tag "$ACR_URL/ensono/eir-azure-data:${{ parameters.EirctlImageTag }}" "ensono/eir-azure-data:${{ parameters.EirctlImageTag }}" >/dev/null 2>&1
            echo "Saving image to cache..."
            docker save "ensono/eir-azure-data:${{ parameters.EirctlImageTag }}" -o "$CACHE_DIR/eir-azure-data.tar"
          else
            echo "Warning: Could not pull $ACR_URL/ensono/eir-azure-data:${{ parameters.EirctlImageTag }} (continuing)"
          fi
        else
          echo "Image ensono/eir-azure-data:${{ parameters.EirctlImageTag }} already exists locally"
        fi

        echo "Images ready: ensono/eir-infrastructure:${{ parameters.EirctlImageTag }}, ensono/eir-azure-data:${{ parameters.EirctlImageTag }}"
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      EIRCTL_IMAGE_TAG: ${{ parameters.EirctlImageTag }}
